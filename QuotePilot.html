<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="appTitle">车险报价对比工具</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.5/purify.min.js"></script>
    
    <style>
        /* CSS Variables for Theming */
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --highlight-bg: #fff3cd;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        html[data-theme='dark'] {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #e0e0e0;
            --border-color: #444;
            --success-color: #198754;
            --danger-color: #dc3545;
            --highlight-bg: #332700;
        }

        /* General Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            padding: 1rem;
        }

        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
        }

        /* Form Panel */
        .form-panel {
            flex: 1;
            min-width: 320px;
            background: var(--surface-color);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 1rem;
            align-self: flex-start;
        }

        .form-panel h2 {
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem 1rem;
            align-items: center;
        }

        .form-group input[type="text"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        #remarks-editor {
            height: 120px;
            background-color: var(--background-color);
            color: var(--text-color);
        }
        .ql-toolbar.ql-snow, .ql-container.ql-snow {
             border-color: var(--border-color);
        }
        .ql-snow .ql-stroke {
            stroke: var(--text-color);
        }

        .submit-btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .submit-btn:hover {
            background-color: #0056b3;
        }
        html[data-theme='dark'] .submit-btn:hover {
            background-color: #0b5ed7;
        }

        /* Results Panel */
        .results-panel {
            flex: 3;
            min-width: 320px;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background: var(--surface-color);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow);
        }
        .toolbar input, .toolbar select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .plans-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .plan-card {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s;
        }
        .plan-card:hover {
            transform: translateY(-5px);
        }

        .plan-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .plan-header h3 {
            margin: 0;
            color: var(--primary-color);
        }
        .plan-header .sales-info {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        .plan-body {
            padding: 1rem;
            flex-grow: 1;
        }

        .plan-item, .plan-total {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px dashed var(--border-color);
        }
        .plan-item:last-child {
            border-bottom: none;
        }
        .plan-item .label, .plan-total .label {
            font-weight: 500;
        }
        .plan-item .value, .plan-total .value {
            text-align: right;
        }
        .plan-item .value .premium {
            color: var(--danger-color);
            font-weight: bold;
        }
        .plan-item .value .coverage {
             color: var(--success-color);
        }

        .plan-total {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--primary-color);
            font-size: 1.1rem;
            font-weight: bold;
        }

        .plan-remarks {
            padding: 1rem;
            margin-top: 1rem;
            background: var(--background-color);
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .plan-remarks h4 {
            margin-bottom: 0.5rem;
        }

        .plan-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }
        .plan-actions button {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            color: var(--text-color);
            transition: background-color 0.2s;
        }
        .plan-actions button.edit-btn:hover { background-color: var(--primary-color); color: white; }
        .plan-actions button.delete-btn:hover { background-color: var(--danger-color); color: white; }
        .plan-actions button.export-btn:hover { background-color: var(--success-color); color: white; }

        .hidden { display: none; }
        
        #global-export-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .export-checkbox {
            margin-right: 0.5rem;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            text-align: center;
        }
        .modal-actions {
            margin-top: 20px;
        }
         .modal-actions button {
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
        }
        .modal-confirm { background-color: var(--danger-color); color: white; }
        .modal-cancel { background-color: var(--secondary-color); color: white; }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            .form-panel {
                position: static;
            }
            .plans-container {
                grid-template-columns: 1fr;
            }
        }
        
        /* Export styling fixes */
        .export-mode {
            padding: 20px !important;
            border: 2px solid #000 !important;
            width: 500px !important; /* Force width for mobile */
            font-size: 14px !important; /* Ensure consistent font size */
        }
        .export-mode .plan-item, .export-mode .plan-total {
            white-space: nowrap; /* Prevent wrapping */
        }
    </style>
</head>
<body>

    <div class="container">
        <aside class="form-panel">
            <h2 data-i18n-key="formTitle">添加/编辑保险方案</h2>
            <form id="plan-form">
                <input type="hidden" id="plan-id">
                
                <div class="form-group-grid">
                    <div class="form-group">
                        <label for="company" data-i18n-key="company">保险公司</label>
                        <input type="text" id="company" placeholder="e.g. 平安保险">
                    </div>
                    <div class="form-group">
                        <label for="sales" data-i18n-key="sales">销售</label>
                        <input type="text" id="sales" placeholder="e.g. 张三">
                    </div>
                </div>
                 <div class="form-group">
                    <label for="contact" data-i18n-key="contact">联系方式</label>
                    <input type="text" id="contact" placeholder="e.g. 13800138000">
                </div>

                <hr style="border:1px solid var(--border-color); margin: 1.5rem 0;">

                <div id="insurance-fields"></div>

                <hr style="border:1px solid var(--border-color); margin: 1.5rem 0;">

                <div class="form-group">
                    <label for="remarks-editor" data-i18n-key="remarks">备注</label>
                    <div id="remarks-editor"></div>
                </div>

                <button type="submit" class="submit-btn" data-i18n-key="addPlanBtn">添加方案</button>
            </form>
        </aside>

        <main class="results-panel">
             <div class="toolbar">
                <input type="search" id="search-input" data-i18n-placeholder="searchPlaceholder" placeholder="按公司、销售搜索...">
                
                <select id="sort-select">
                    <option value="date_desc" data-i18n-key="sortByDateDesc">按时间降序</option>
                    <option value="date_asc" data-i18n-key="sortByDateAsc">按时间升序</option>
                    <option value="company_asc" data-i18n-key="sortByCompanyAsc">按公司名升序</option>
                </select>

                <select id="lang-select"></select>

                <button id="theme-toggle-btn" aria-label="Toggle theme">
                    <i class="fas fa-moon"></i>
                </button>
                
                <button id="global-export-btn"><i class="fas fa-camera"></i> <span data-i18n-key="exportSelectedBtn">导出选中</span></button>
            </div>
            
            <div id="plans-container" class="plans-container">
                </div>
        </main>
    </div>

    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <p id="delete-modal-text" data-i18n-key="deleteConfirmText">您确定要删除这个方案吗？此操作无法撤销。</p>
            <div class="modal-actions">
                <button id="modal-confirm-btn" class="modal-confirm" data-i18n-key="confirmBtn">确定</button>
                <button id="modal-cancel-btn" class="modal-cancel" data-i18n-key="cancelBtn">取消</button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- I18N (Internationalization) ---
        const translations = {
            en: {
                appTitle: "Car Insurance Comparator",
                formTitle: "Add/Edit Insurance Plan",
                company: "Insurance Company",
                sales: "Salesperson",
                contact: "Contact Info",
                remarks: "Remarks",
                addPlanBtn: "Add Plan",
                updatePlanBtn: "Update Plan",
                searchPlaceholder: "Search by company, salesperson...",
                sortByDateDesc: "Sort by Date (Newest)",
                sortByDateAsc: "Sort by Date (Oldest)",
                sortByCompanyAsc: "Sort by Company (A-Z)",
                exportSelectedBtn: "Export Selected",
                deleteConfirmText: "Are you sure you want to delete this plan? This action cannot be undone.",
                confirmBtn: "Confirm",
                cancelBtn: "Cancel",
                editBtn: "Edit",
                deleteBtn: "Delete",
                exportBtn: "Export",
                coverage: "Coverage",
                premium: "Premium",
                totalCoverage: "Total Coverage",
                totalPremium: "Total Premium",
                salesInfoLabel: "Sales",
                contactInfoLabel: "Contact",
                planSaved: "Plan saved successfully!",
                planUpdated: "Plan updated successfully!",
                planDeleted: "Plan deleted.",
                noPlans: "No insurance plans saved yet. Add one using the form on the left.",
                insuranceItems: {
                    vehicleDamage: { label: "Vehicle Damage", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "Third-Party Liability", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "Supplementary Medical", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "Driver Liability", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "Passenger Liability", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "Compulsory Insurance", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "Vehicle & Vessel Tax", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "Driving Accident", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
            'zh-CN': {
                appTitle: "车险报价对比工具",
                formTitle: "添加/编辑保险方案",
                company: "保险公司",
                sales: "销售",
                contact: "联系方式",
                remarks: "备注",
                addPlanBtn: "添加方案",
                updatePlanBtn: "更新方案",
                searchPlaceholder: "按公司、销售搜索...",
                sortByDateDesc: "按时间降序",
                sortByDateAsc: "按时间升序",
                sortByCompanyAsc: "按公司名升序",
                exportSelectedBtn: "导出选中",
                deleteConfirmText: "您确定要删除这个方案吗？此操作无法撤销。",
                confirmBtn: "确定",
                cancelBtn: "取消",
                editBtn: "编辑",
                deleteBtn: "删除",
                exportBtn: "导出",
                coverage: "保额",
                premium: "保费",
                totalCoverage: "总保额",
                totalPremium: "总保费",
                salesInfoLabel: "销售",
                contactInfoLabel: "联系",
                planSaved: "方案已保存！",
                planUpdated: "方案已更新！",
                planDeleted: "方案已删除。",
                noPlans: "暂无保险方案，请使用左侧表单添加。",
                insuranceItems: {
                    vehicleDamage: { label: "机动车损失险", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "机动车第三者责任险", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "三者附加医保外医疗", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "机动车司机责任险", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "机动车乘客责任险", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "交强险", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "车船税", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "驾驶意外险", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
            'zh-TW': {
                appTitle: "車險報價對比工具",
                formTitle: "新增/編輯保險方案",
                company: "保險公司",
                sales: "銷售",
                contact: "聯絡方式",
                remarks: "備註",
                addPlanBtn: "新增方案",
                updatePlanBtn: "更新方案",
                searchPlaceholder: "按公司、銷售搜尋...",
                sortByDateDesc: "按時間降序",
                sortByDateAsc: "按時間升序",
                sortByCompanyAsc: "按公司名升序",
                exportSelectedBtn: "匯出選中",
                deleteConfirmText: "您確定要刪除這個方案嗎？此操作無法撤銷。",
                confirmBtn: "確定",
                cancelBtn: "取消",
                editBtn: "編輯",
                deleteBtn: "刪除",
                exportBtn: "匯出",
                coverage: "保額",
                premium: "保費",
                totalCoverage: "總保額",
                totalPremium: "總保費",
                salesInfoLabel: "銷售",
                contactInfoLabel: "聯絡",
                planSaved: "方案已儲存！",
                planUpdated: "方案已更新！",
                planDeleted: "方案已刪除。",
                noPlans: "暫無保險方案，請使用左側表單新增。",
                insuranceItems: {
                    vehicleDamage: { label: "機動車損失險", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "機動車第三者責任險", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "三者附加醫保外醫療", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "機動車司機責任险", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "機動車乘客責任险", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "交強險", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "車船稅", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "駕駛意外險", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
            de: {
                appTitle: "Kfz-Versicherungsvergleich",
                formTitle: "Versicherungsplan hinzufügen/bearbeiten",
                company: "Versicherungsgesellschaft",
                sales: "Verkäufer",
                contact: "Kontakt",
                remarks: "Bemerkungen",
                addPlanBtn: "Plan hinzufügen",
                updatePlanBtn: "Plan aktualisieren",
                searchPlaceholder: "Suche nach Firma, Verkäufer...",
                sortByDateDesc: "Nach Datum (neueste)",
                sortByDateAsc: "Nach Datum (älteste)",
                sortByCompanyAsc: "Nach Firma (A-Z)",
                exportSelectedBtn: "Ausgewählte exportieren",
                deleteConfirmText: "Möchten Sie diesen Plan wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden.",
                confirmBtn: "Bestätigen",
                cancelBtn: "Abbrechen",
                editBtn: "Bearbeiten",
                deleteBtn: "Löschen",
                exportBtn: "Exportieren",
                coverage: "Deckung",
                premium: "Prämie",
                totalCoverage: "Gesamtdeckung",
                totalPremium: "Gesamtprämie",
                salesInfoLabel: "Verkäufer",
                contactInfoLabel: "Kontakt",
                planSaved: "Plan erfolgreich gespeichert!",
                planUpdated: "Plan erfolgreich aktualisiert!",
                planDeleted: "Plan gelöscht.",
                noPlans: "Noch keine Versicherungspläne gespeichert. Fügen Sie einen über das Formular links hinzu.",
                insuranceItems: {
                    vehicleDamage: { label: "Fahrzeugschaden", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "Haftpflicht", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "Zusätzliche Krankenversicherung", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "Fahrerhaftpflicht", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "Insassenhaftpflicht", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "Pflichtversicherung", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "Kfz-Steuer", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "Fahrunfall", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
            ja: {
                appTitle: "自動車保険見積比較ツール",
                formTitle: "保険プランの追加/編集",
                company: "保険会社",
                sales: "営業担当者",
                contact: "連絡先",
                remarks: "備考",
                addPlanBtn: "プランを追加",
                updatePlanBtn: "プランを更新",
                searchPlaceholder: "会社名、営業担当者で検索...",
                sortByDateDesc: "日付順（新しい順）",
                sortByDateAsc: "日付順（古い順）",
                sortByCompanyAsc: "会社名順（昇順）",
                exportSelectedBtn: "選択項目をエクスポート",
                deleteConfirmText: "このプランを本当に削除しますか？この操作は元に戻せません。",
                confirmBtn: "確認",
                cancelBtn: "キャンセル",
                editBtn: "編集",
                deleteBtn: "削除",
                exportBtn: "エクスポート",
                coverage: "補償額",
                premium: "保険料",
                totalCoverage: "総補償額",
                totalPremium: "総保険料",
                salesInfoLabel: "営業",
                contactInfoLabel: "連絡先",
                planSaved: "プランが保存されました！",
                planUpdated: "プランが更新されました！",
                planDeleted: "プランが削除されました。",
                noPlans: "保険プランはまだありません。左のフォームで追加してください。",
                insuranceItems: {
                    vehicleDamage: { label: "車両保険", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "対人賠償責任保険", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "対人臨時費用", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "運転者傷害保険", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "搭乗者傷害保険", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "自賠責保険", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "自動車税", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "運転事故保険", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
             ko: {
                appTitle: "자동차 보험 견적 비교 도구",
                formTitle: "보험 플랜 추가/편집",
                company: "보험사",
                sales: "영업 사원",
                contact: "연락처",
                remarks: "비고",
                addPlanBtn: "플랜 추가",
                updatePlanBtn: "플랜 업데이트",
                searchPlaceholder: "회사, 영업 사원으로 검색...",
                sortByDateDesc: "날짜순 (최신순)",
                sortByDateAsc: "날짜순 (오래된순)",
                sortByCompanyAsc: "회사명순 (오름차순)",
                exportSelectedBtn: "선택 항목 내보내기",
                deleteConfirmText: "이 플랜을 정말로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.",
                confirmBtn: "확인",
                cancelBtn: "취소",
                editBtn: "편집",
                deleteBtn: "삭제",
                exportBtn: "내보내기",
                coverage: "보장 금액",
                premium: "보험료",
                totalCoverage: "총 보장 금액",
                totalPremium: "총 보험료",
                salesInfoLabel: "영업",
                contactInfoLabel: "연락처",
                planSaved: "플랜이 성공적으로 저장되었습니다!",
                planUpdated: "플랜이 성공적으로 업데이트되었습니다!",
                planDeleted: "플랜이 삭제되었습니다.",
                noPlans: "저장된 보험 플랜이 없습니다. 왼쪽 양식을 사용하여 추가하십시오.",
                insuranceItems: {
                    vehicleDamage: { label: "자차손해", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "대인배상", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "대인 추가 의료비", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "운전자 책임", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "동승자 책임", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "의무보험", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "자동차세", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "운전 사고 보험", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
            fr: {
                appTitle: "Comparateur d'assurance auto",
                formTitle: "Ajouter/Modifier un plan d'assurance",
                company: "Compagnie d'assurance",
                sales: "Vendeur",
                contact: "Contact",
                remarks: "Remarques",
                addPlanBtn: "Ajouter un plan",
                updatePlanBtn: "Mettre à jour le plan",
                searchPlaceholder: "Rechercher par compagnie, vendeur...",
                sortByDateDesc: "Trier par date (plus récent)",
                sortByDateAsc: "Trier par date (plus ancien)",
                sortByCompanyAsc: "Trier par compagnie (A-Z)",
                exportSelectedBtn: "Exporter la sélection",
                deleteConfirmText: "Êtes-vous sûr de vouloir supprimer ce plan ? Cette action est irréversible.",
                confirmBtn: "Confirmer",
                cancelBtn: "Annuler",
                editBtn: "Modifier",
                deleteBtn: "Supprimer",
                exportBtn: "Exporter",
                coverage: "Couverture",
                premium: "Prime",
                totalCoverage: "Couverture totale",
                totalPremium: "Prime totale",
                salesInfoLabel: "Vendeur",
                contactInfoLabel: "Contact",
                planSaved: "Plan enregistré avec succès !",
                planUpdated: "Plan mis à jour avec succès !",
                planDeleted: "Plan supprimé.",
                noPlans: "Aucun plan d'assurance enregistré. Ajoutez-en un via le formulaire à gauche.",
                insuranceItems: {
                    vehicleDamage: { label: "Dommages au véhicule", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "Responsabilité civile", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "Frais médicaux supplémentaires", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "Responsabilité du conducteur", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "Responsabilité des passagers", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "Assurance obligatoire", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "Taxe sur les véhicules", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "Accident de la route", defaultCoverage: 100000, defaultPremium: 200 },
                }
            },
            ru: {
                appTitle: "Сравнение автострахования",
                formTitle: "Добавить/изменить план страхования",
                company: "Страховая компания",
                sales: "Продавец",
                contact: "Контакт",
                remarks: "Примечания",
                addPlanBtn: "Добавить план",
                updatePlanBtn: "Обновить план",
                searchPlaceholder: "Поиск по компании, продавцу...",
                sortByDateDesc: "Сортировать по дате (сначала новые)",
                sortByDateAsc: "Сортировать по дате (сначала старые)",
                sortByCompanyAsc: "Сортировать по компании (А-Я)",
                exportSelectedBtn: "Экспорт выбранного",
                deleteConfirmText: "Вы уверены, что хотите удалить этот план? Это действие необратимо.",
                confirmBtn: "Подтвердить",
                cancelBtn: "Отмена",
                editBtn: "Редактировать",
                deleteBtn: "Удалить",
                exportBtn: "Экспорт",
                coverage: "Покрытие",
                premium: "Премия",
                totalCoverage: "Общее покрытие",
                totalPremium: "Общая премия",
                salesInfoLabel: "Продавец",
                contactInfoLabel: "Контакт",
                planSaved: "План успешно сохранен!",
                planUpdated: "План успешно обновлен!",
                planDeleted: "План удален.",
                noPlans: "Нет сохраненных планов страхования. Добавьте один с помощью формы слева.",
                insuranceItems: {
                    vehicleDamage: { label: "Ущерб транспортному средству", defaultCoverage: 200000, defaultPremium: 2000 },
                    thirdParty: { label: "Гражданская ответственность", defaultCoverage: 3000000, defaultPremium: 1500 },
                    thirdPartyMedical: { label: "Дополнительное медицинское страхование", defaultCoverage: 50000, defaultPremium: 100 },
                    driverLiability: { label: "Ответственность водителя", defaultCoverage: 50000, defaultPremium: 50 },
                    passengerLiability: { label: "Ответственность перед пассажирами", defaultCoverage: 50000, defaultPremium: 150 },
                    compulsory: { label: "Обязательное страхование", defaultCoverage: 200000, defaultPremium: 950 },
                    vehicleTax: { label: "Транспортный налог", defaultCoverage: 0, defaultPremium: 360 },
                    drivingAccident: { label: "Страхование от несчастных случаев при вождении", defaultCoverage: 100000, defaultPremium: 200 },
                }
            }
        };

        const supportedLangs = {
            'en': 'English',
            'zh-CN': '简体中文',
            'zh-TW': '繁體中文',
            'de': 'Deutsch',
            'ja': '日本語',
            'ko': '한국어',
            'fr': 'Français',
            'ru': 'Русский'
        };
        
        let currentLang = localStorage.getItem('appLanguage') || 'zh-CN';
        const insuranceItems = translations[currentLang].insuranceItems;

        const langSelect = document.getElementById('lang-select');
        for (const [code, name] of Object.entries(supportedLangs)) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = name;
            if (code === currentLang) {
                option.selected = true;
            }
            langSelect.appendChild(option);
        }

        const setLanguage = (lang) => {
            currentLang = lang;
            localStorage.setItem('appLanguage', lang);
            document.documentElement.lang = lang;
            
            const t = translations[lang];
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                 if (t[key]) {
                    el.placeholder = t[key];
                }
            });
            generateInsuranceFields();
            renderPlans();
        };
        langSelect.addEventListener('change', (e) => setLanguage(e.target.value));

        // --- Rich Text Editor ---
        const quill = new Quill('#remarks-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                ]
            }
        });

        // --- DOM Elements ---
        const form = document.getElementById('plan-form');
        const planIdInput = document.getElementById('plan-id');
        const plansContainer = document.getElementById('plans-container');
        const searchInput = document.getElementById('search-input');
        const sortSelect = document.getElementById('sort-select');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const insuranceFieldsContainer = document.getElementById('insurance-fields');
        const globalExportBtn = document.getElementById('global-export-btn');
        
        // --- Modal ---
        const modal = document.getElementById('delete-modal');
        const confirmBtn = document.getElementById('modal-confirm-btn');
        const cancelBtn = document.getElementById('modal-cancel-btn');
        let deleteCallback = null;

        const showModal = (callback) => {
            deleteCallback = callback;
            modal.style.display = 'flex';
        };

        const hideModal = () => {
            modal.style.display = 'none';
            deleteCallback = null;
        };

        confirmBtn.addEventListener('click', () => {
            if (deleteCallback) {
                deleteCallback();
            }
            hideModal();
        });
        cancelBtn.addEventListener('click', hideModal);
        window.addEventListener('click', (event) => {
            if (event.target == modal) {
                hideModal();
            }
        });


        // --- Local Storage ---
        const getPlans = () => JSON.parse(localStorage.getItem('insurancePlans') || '[]');
        const savePlans = (plans) => localStorage.setItem('insurancePlans', JSON.stringify(plans));
        
        // --- Theme ---
        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('theme', theme);
        };
        themeToggleBtn.addEventListener('click', () => {
            const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
        });
        
        // --- Generate Dynamic Form Fields ---
        const generateInsuranceFields = () => {
            insuranceFieldsContainer.innerHTML = '';
            const items = translations[currentLang].insuranceItems;
            for (const key in items) {
                const item = items[key];
                const fieldHtml = `
                    <div class="form-group">
                        <label>${item.label}</label>
                        <div class="form-group-grid">
                            <input type="number" step="0.01" id="${key}-coverage" placeholder="${translations[currentLang].coverage}" value="${item.defaultCoverage}" required>
                            <input type="number" step="0.01" id="${key}-premium" placeholder="${translations[currentLang].premium}" value="${item.defaultPremium}" required>
                        </div>
                    </div>
                `;
                insuranceFieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
            }
        };

        // --- Render Plans ---
        const renderPlans = () => {
            let plans = getPlans();
            const searchTerm = searchInput.value.toLowerCase();
            const sortValue = sortSelect.value;
            
            // Filter
            if (searchTerm) {
                plans = plans.filter(p => 
                    p.company.toLowerCase().includes(searchTerm) || 
                    p.sales.toLowerCase().includes(searchTerm)
                );
            }

            // Sort
            plans.sort((a, b) => {
                switch (sortValue) {
                    case 'date_asc': return a.id - b.id;
                    case 'company_asc': return a.company.localeCompare(b.company);
                    case 'date_desc':
                    default:
                        return b.id - a.id;
                }
            });

            // Keep only recent 10 if needed (optional, current setup shows all filtered/sorted)
            // plans = plans.slice(0, 10);

            plansContainer.innerHTML = '';
            if (plans.length === 0) {
                 plansContainer.innerHTML = `<p>${translations[currentLang].noPlans}</p>`;
                 return;
            }

            plans.forEach(plan => {
                let totalCoverage = 0;
                let totalPremium = 0;
                let itemsHtml = '';
                const t = translations[currentLang];

                for (const key in plan.items) {
                    const item = plan.items[key];
                    const itemDef = t.insuranceItems[key] || { label: key };
                    totalCoverage += parseFloat(item.coverage);
                    totalPremium += parseFloat(item.premium);
                    itemsHtml += `
                        <div class="plan-item">
                            <span class="label">${itemDef.label}</span>
                            <span class="value">
                                <span class="coverage">${t.coverage}: ${parseFloat(item.coverage).toLocaleString()}</span> /
                                <span class="premium">${t.premium}: ${parseFloat(item.premium).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </span>
                        </div>
                    `;
                }
                
                // Sanitize user HTML content from Quill
                const sanitizedRemarks = DOMPurify.sanitize(plan.remarks);

                const cardHtml = `
                    <div class="plan-card" id="plan-${plan.id}">
                         <div class="plan-header">
                            <h3><input type="checkbox" class="export-checkbox" data-plan-id="${plan.id}"> ${plan.company}</h3>
                            <div class="sales-info">
                                ${plan.sales ? `<span>${t.salesInfoLabel}: ${plan.sales}</span>` : ''}
                                ${plan.contact ? ` | <span>${t.contactInfoLabel}: ${plan.contact}</span>` : ''}
                            </div>
                        </div>
                        <div class="plan-body">
                            ${itemsHtml}
                            <div class="plan-total">
                                <span class="label">${t.totalCoverage}</span>
                                <span class="value">${totalCoverage.toLocaleString()}</span>
                            </div>
                            <div class="plan-total">
                                <span class="label">${t.totalPremium}</span>
                                <span class="value">${totalPremium.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                             ${sanitizedRemarks ? `
                                <div class="plan-remarks">
                                    <h4>${t.remarks}</h4>
                                    <div>${sanitizedRemarks}</div>
                                </div>` 
                            : ''}
                        </div>
                        <div class="plan-actions">
                            <button class="edit-btn" data-id="${plan.id}"><i class="fas fa-edit"></i> ${t.editBtn}</button>
                            <button class="delete-btn" data-id="${plan.id}"><i class="fas fa-trash"></i> ${t.deleteBtn}</button>
                            <button class="export-btn" data-id="${plan.id}"><i class="fas fa-camera"></i> ${t.exportBtn}</button>
                        </div>
                    </div>
                `;
                plansContainer.insertAdjacentHTML('beforeend', cardHtml);
            });
        };

        // --- Form Submission ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = planIdInput.value;
            const items = {};
            for (const key in translations[currentLang].insuranceItems) {
                items[key] = {
                    coverage: parseFloat(document.getElementById(`${key}-coverage`).value) || 0,
                    premium: parseFloat(document.getElementById(`${key}-premium`).value) || 0
                };
            }

            const plan = {
                id: id ? parseInt(id) : Date.now(),
                company: document.getElementById('company').value.trim() || '未命名方案',
                sales: document.getElementById('sales').value.trim(),
                contact: document.getElementById('contact').value.trim(),
                items: items,
                remarks: quill.root.innerHTML
            };
            
            // XSS Prevention for plain text fields
            plan.company = DOMPurify.sanitize(plan.company, { USE_PROFILES: { html: false } });
            plan.sales = DOMPurify.sanitize(plan.sales, { USE_PROFILES: { html: false } });
            plan.contact = DOMPurify.sanitize(plan.contact, { USE_PROFILES: { html: false } });

            let plans = getPlans();
            if (id) {
                // Update
                const index = plans.findIndex(p => p.id === parseInt(id));
                if (index !== -1) {
                    plans[index] = plan;
                }
                alert(translations[currentLang].planUpdated);
            } else {
                // Add
                plans.push(plan);
                alert(translations[currentLang].planSaved);
            }
            savePlans(plans);
            form.reset();
            planIdInput.value = '';
            quill.root.innerHTML = '';
            document.querySelector('.submit-btn').textContent = translations[currentLang].addPlanBtn;
            renderPlans();
        });

        // --- Actions (Edit, Delete, Export) ---
        plansContainer.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = parseInt(target.dataset.id);

            if (target.classList.contains('edit-btn')) {
                const plans = getPlans();
                const planToEdit = plans.find(p => p.id === id);
                if (planToEdit) {
                    planIdInput.value = planToEdit.id;
                    document.getElementById('company').value = planToEdit.company;
                    document.getElementById('sales').value = planToEdit.sales;
                    document.getElementById('contact').value = planToEdit.contact;
                    for (const key in planToEdit.items) {
                        document.getElementById(`${key}-coverage`).value = planToEdit.items[key].coverage;
                        document.getElementById(`${key}-premium`).value = planToEdit.items[key].premium;
                    }
                    quill.root.innerHTML = planToEdit.remarks;
                    document.querySelector('.submit-btn').textContent = translations[currentLang].updatePlanBtn;
                    window.scrollTo(0, 0);
                }
            } else if (target.classList.contains('delete-btn')) {
                showModal(() => {
                    let plans = getPlans();
                    plans = plans.filter(p => p.id !== id);
                    savePlans(plans);
                    alert(translations[currentLang].planDeleted);
                    renderPlans();
                });
            } else if (target.classList.contains('export-btn')) {
                exportAsImage(`plan-${id}`);
            }
        });

        // --- Image Export ---
        const exportAsImage = (elementId, filename = 'insurance-plan.png') => {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // Add a class for specific export styling and remove checkbox from output
            element.classList.add('export-mode');
            const checkbox = element.querySelector('.export-checkbox');
            if (checkbox) checkbox.style.display = 'none';

            html2canvas(element, {
                scale: 2, // Higher resolution
                useCORS: true,
                backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' ? '#1e1e1e' : '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = filename;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Cleanup
                element.classList.remove('export-mode');
                if (checkbox) checkbox.style.display = 'inline-block';
            });
        };
        
        globalExportBtn.addEventListener('click', () => {
            const selectedIds = Array.from(document.querySelectorAll('.export-checkbox:checked')).map(cb => cb.dataset.planId);
            if(selectedIds.length === 0) {
                alert('Please select at least one plan to export.');
                return;
            }

            // Create a temporary container for selected cards
            const exportContainer = document.createElement('div');
            exportContainer.style.position = 'absolute';
            exportContainer.style.left = '-9999px'; // Hide it off-screen
            exportContainer.style.display = 'flex';
            exportContainer.style.gap = '20px';
            exportContainer.style.padding = '20px';
            exportContainer.style.background = document.documentElement.getAttribute('data-theme') === 'dark' ? '#121212' : '#f8f9fa';

            selectedIds.forEach(id => {
                const originalCard = document.getElementById(`plan-${id}`);
                const clonedCard = originalCard.cloneNode(true);
                clonedCard.id = `clone-${id}`;
                clonedCard.style.margin = '0'; // Reset margin
                const checkbox = clonedCard.querySelector('.export-checkbox');
                if (checkbox) checkbox.style.display = 'none';
                exportContainer.appendChild(clonedCard);
            });
            document.body.appendChild(exportContainer);

            // Temporarily set a fixed width for consistent rendering, especially on mobile
             const cards = exportContainer.querySelectorAll('.plan-card');
             const totalWidth = Array.from(cards).reduce((acc, card) => acc + card.offsetWidth + 20, 0);
             exportContainer.style.width = `${totalWidth}px`;

            html2canvas(exportContainer, {
                scale: 2,
                useCORS: true,
                backgroundColor: document.documentElement.getAttribute('data-theme') === 'dark' ? '#121212' : '#f8f9fa'
            }).then(canvas => {
                 const link = document.createElement('a');
                link.download = `insurance-comparison-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(exportContainer);
            }).catch(err => {
                console.error('Export failed:', err);
                document.body.removeChild(exportContainer);
            });
        });

        // --- Event Listeners for Toolbar ---
        searchInput.addEventListener('input', renderPlans);
        sortSelect.addEventListener('change', renderPlans);

        // --- Keyboard Shortcut (Ctrl+Enter to submit) ---
        form.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            }
        });

        // --- Initial Load ---
        const init = () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);
            setLanguage(currentLang); // This will call generateInsuranceFields and renderPlans
        };

        init();
    });
    </script>
</body>
</html>