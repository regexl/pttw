<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="310332c6-bb2a-4410-90c1-0d681395f9b2"></script>
    <title>è½¦é™©æ–¹æ¡ˆå¯¹æ¯”åˆ†æå·¥å…·</title>
    <meta name="description" content="ä¸€æ¬¾å¸®åŠ©æ‚¨å¯¹æ¯”å’Œè¯„ä¼°å¤šä¸ªæ±½è½¦ä¿é™©æŠ¥ä»·æ–¹æ¡ˆçš„ä¸“ä¸šå·¥å…·ã€‚è½»æ¾å½•å…¥ã€æ™ºèƒ½å¯¹æ¯”ã€ä¸€é”®å¯¼å‡ºï¼Œé€‰æ‹©æœ€ä¼˜è½¦é™©ã€‚">
    <meta name="author" content="Gemini - AI Financial Frontend Expert">
    <meta name="keywords" content="è½¦é™©å¯¹æ¯”, ä¿è´¹è¯„ä¼°, ä¿é¢åˆ†æ, æ±½è½¦ä¿é™©, é‡‘èå·¥å…·">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›¡ï¸</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.quilljs.com/2.0.0-rc.4/quill.snow.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/iconfont/tabler-icons.min.css">

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --dark-bg: #1e293b;
            --card-bg: #ffffff;
            --card-dark-bg: #334155;
        }
        
        html {
            scroll-behavior: smooth;
            font-family: 'Helvetica Neue', Arial, 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif;
        }

        .dark {
            --card-bg: var(--card-dark-bg);
        }

        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #1a202c; }
        .dark ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #718096; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        #remarks-editor { height: 150px; }

        @media (max-width: 1024px) {
            .main-container { flex-direction: column; }
            .left-panel, .right-panel { width: 100%; }
            .left-panel { position: static; height: auto; }
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: var(--primary-color);
            border: 2px dashed #fff;
        }
        
        .transition-all { transition: all 0.3s ease-in-out; }
        .plan-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .plan-card:hover { transform: translateY(-5px); }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            padding: 5px 10px;
            background-color: #2d3748;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 10;
        }
        
        /* å¸ƒå±€åˆ‡æ¢æ ·å¼ */
        .layout-btn {
            background: var(--card-bg);
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .layout-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .layout-btn:hover {
            background: #eef2ff;
        }
        
        .dark .layout-btn:hover {
            background: #475569;
        }
        
        .horizontal-layout .plans-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .horizontal-layout .plan-card {
            width: calc(50% - 10px);
            min-width: 450px;
        }
        
        @media (max-width: 1200px) {
            .horizontal-layout .plan-card {
                width: 100%;
            }
        }
        
        .vertical-layout .plans-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .chart-container {
            height: 200px;
            width: 100%;
        }
        
        .comparison-view {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 10px 0;
            margin-top: 20px;
        }
        
        .comparison-card {
            min-width: 300px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .export-content {
            background: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
        }
        
        .dark .export-content {
            background: var(--dark-bg);
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-all">

    <header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-30">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="ti ti-shield-half-filled text-3xl text-indigo-600"></i>
                <h1 class="text-xl font-bold">è½¦é™©æ–¹æ¡ˆå¯¹æ¯”åˆ†æå·¥å…·</h1>
            </div>
            <div class="flex items-center gap-4">
                <select id="language-switcher" class="bg-slate-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 rounded-md text-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                    <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                    <option value="en">English</option>
                </select>
                <button id="theme-toggle" class="relative" data-tooltip="åˆ‡æ¢æ¨¡å¼">
                    <i class="ti ti-sun text-2xl dark:hidden"></i>
                    <i class="ti ti-moon text-2xl hidden dark:inline"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-6">
        <div class="flex gap-6 main-container">
            <div class="left-panel lg:w-1/3 lg:sticky lg:top-20 self-start bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <form id="plan-form">
                    <input type="hidden" id="plan-id">
                    <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                        <i class="ti ti-circle-plus"></i>
                        <span>æ·»åŠ /ç¼–è¾‘æ–¹æ¡ˆ</span>
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <input type="text" id="plan-title" placeholder="æ–¹æ¡ˆæ ‡é¢˜ (ä¾‹å¦‚ï¼šå¹³å®‰-ç‹ç»ç†-æ–¹æ¡ˆA)" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        <input type="text" id="insurance-company" placeholder="ä¿é™©å…¬å¸ (é€‰å¡«)" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <input type="text" id="salesperson" placeholder="é”€å”® (é€‰å¡«)" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                        <input type="text" id="contact-info" placeholder="è”ç³»æ–¹å¼ (é€‰å¡«)" class="w-full p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                    </div>
                    
                    <div id="insurance-items-container" class="space-y-3 mb-4">
                        <!-- é™©ç§é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">å¤‡æ³¨ (Ctrl+Enter æäº¤)</label>
                        <div id="remarks-editor" class="bg-white dark:bg-gray-700"></div>
                    </div>
                    
                    <div class="flex gap-4 mt-6">
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center gap-2">
                            <i class="ti ti-device-floppy"></i>
                            <span>ä¿å­˜æ–¹æ¡ˆ</span>
                        </button>
                        <button type="button" id="clear-form-btn" class="w-1/3 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500 transition-colors">
                            <span>æ¸…ç©º</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="right-panel lg:w-2/3">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-4 items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="ti ti-filter"></i>
                        <span class="font-bold">ç­›é€‰ä¸æ’åº</span>
                    </div>
                    <div class="flex flex-wrap gap-4 items-center">
                        <select id="sort-by" class="p-2 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600">
                            <option value="date_desc">æŒ‰æ—¶é—´é™åº</option>
                            <option value="date_asc">æŒ‰æ—¶é—´å‡åº</option>
                            <option value="premium_asc">æŒ‰æ€»ä¿è´¹å‡åº</option>
                            <option value="premium_desc">æŒ‰æ€»ä¿è´¹é™åº</option>
                            <option value="coverage_desc">æŒ‰æ€»ä¿é¢é™åº</option>
                        </select>
                        
                        <!-- å¸ƒå±€åˆ‡æ¢æŒ‰é’® -->
                        <div class="flex items-center gap-2">
                            <span>å¸ƒå±€:</span>
                            <div class="flex gap-1">
                                <button id="horizontal-layout-btn" class="layout-btn active" data-layout="horizontal">
                                    <i class="ti ti-layout-grid"></i> æ¨ªå‘
                                </button>
                                <button id="vertical-layout-btn" class="layout-btn" data-layout="vertical">
                                    <i class="ti ti-layout-rows"></i> çºµå‘
                                </button>
                            </div>
                        </div>
                        
                        <div class="flex-grow flex gap-2">
                            <button id="export-all-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                <i class="ti ti-photo-down"></i>
                                <span>å¯¼å‡ºå¯¹æ¯”å›¾</span>
                            </button>
                            <button id="comparison-view-btn" class="bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors flex items-center justify-center gap-2">
                                <i class="ti ti-layout-sidebar-right"></i>
                                <span>å¯¹æ¯”è§†å›¾</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="plans-container" class="horizontal-layout">
                    <div class="plans-container">
                        <!-- æ–¹æ¡ˆå¡ç‰‡å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div id="comparison-container" class="hidden">
                    <!-- å¯¹æ¯”è§†å›¾å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div id="no-plans-placeholder" class="text-center py-12">
                    <i class="ti ti-file-off text-6xl text-gray-400"></i>
                    <p class="mt-4 text-gray-500">æš‚æ— æ–¹æ¡ˆï¼Œè¯·åœ¨å·¦ä¾§æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªä¿é™©æ–¹æ¡ˆã€‚</p>
                </div>
            </div>
        </div>
    </main>

    <!-- å¯¼å‡ºæ¨¡æ€æ¡† -->
    <div id="export-modal" class="export-modal hidden">
        <div class="export-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">å¯¼å‡ºå¯¹æ¯”å›¾</h3>
                <button id="close-export-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="ti ti-x text-2xl"></i>
                </button>
            </div>
            <div id="export-preview" class="bg-white dark:bg-gray-800 p-4 rounded-lg">
                <!-- å¯¼å‡ºé¢„è§ˆå†…å®¹ -->
            </div>
            <div class="mt-4 flex justify-end gap-2">
                <button id="export-png-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">
                    <i class="ti ti-download"></i> å¯¼å‡ºPNG
                </button>
                <button id="export-pdf-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">
                    <i class="ti ti-file-download"></i> å¯¼å‡ºPDF
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.bootcdn.net/ajax/libs/quill/2.0.0-rc.4/quill.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/SortableJS/1.15.2/Sortable.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/dompurify/3.1.4/purify.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.5.0/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // å…¨å±€çŠ¶æ€ç®¡ç†
        const state = {
            plans: JSON.parse(localStorage.getItem('insurancePlans')) || [],
            editingId: null,
            currentLanguage: localStorage.getItem('language') || 'zh-CN',
            layout: localStorage.getItem('layout') || 'horizontal',
            comparisonMode: false
        };

        // é™©ç§ç±»å‹é…ç½®
        const insuranceTypes = {
            'vehicleDamage': { name: 'æœºåŠ¨è½¦æŸå¤±é™©', defaultCoverage: 200000, defaultPremium: 2000 },
            'thirdPartyLiability': { name: 'ç¬¬ä¸‰è€…è´£ä»»é™©', defaultCoverage: 2000000, defaultPremium: 1500 },
            'thirdPartyMedical': { name: 'ä¸‰è€…åŒ»ä¿å¤–åŒ»ç–—', defaultCoverage: 50000, defaultPremium: 80 },
            'driverLiability': { name: 'å¸æœºè´£ä»»é™©', defaultCoverage: 50000, defaultPremium: 50 },
            'passengerLiability': { name: 'ä¹˜å®¢è´£ä»»é™©', defaultCoverage: 50000, defaultPremium: 100 },
            'compulsory': { name: 'äº¤å¼ºé™©', defaultCoverage: 200000, defaultPremium: 950 },
            'vehicleTax': { name: 'è½¦èˆ¹ç¨', defaultCoverage: 0, defaultPremium: 360 },
            'drivingAccident': { name: 'é©¾é©¶æ„å¤–é™©', defaultCoverage: 200000, defaultPremium: 200 }
        };

        // DOMå…ƒç´ è·å–
        const form = document.getElementById('plan-form');
        const planIdInput = document.getElementById('plan-id');
        const planTitleInput = document.getElementById('plan-title');
        const insuranceItemsContainer = document.getElementById('insurance-items-container');
        const plansContainer = document.querySelector('.plans-container');
        const noPlansPlaceholder = document.getElementById('no-plans-placeholder');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const sortBySelect = document.getElementById('sort-by');
        const exportAllBtn = document.getElementById('export-all-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const langSwitcher = document.getElementById('language-switcher');
        const horizontalLayoutBtn = document.getElementById('horizontal-layout-btn');
        const verticalLayoutBtn = document.getElementById('vertical-layout-btn');
        const comparisonViewBtn = document.getElementById('comparison-view-btn');
        const comparisonContainer = document.getElementById('comparison-container');
        const exportModal = document.getElementById('export-modal');
        const exportPreview = document.getElementById('export-preview');
        const closeExportModal = document.getElementById('close-export-modal');
        const exportPngBtn = document.getElementById('export-png-btn');
        const exportPdfBtn = document.getElementById('export-pdf-btn');

        // Quillç¼–è¾‘å™¨åˆå§‹åŒ–
        const quill = new Quill('#remarks-editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                ]
            }
        });

        // åˆå§‹åŒ–å¸ƒå±€
        function initLayout() {
            if (state.layout === 'horizontal') {
                horizontalLayoutBtn.classList.add('active');
                verticalLayoutBtn.classList.remove('active');
                document.getElementById('plans-container').classList.add('horizontal-layout');
                document.getElementById('plans-container').classList.remove('vertical-layout');
            } else {
                verticalLayoutBtn.classList.add('active');
                horizontalLayoutBtn.classList.remove('active');
                document.getElementById('plans-container').classList.add('vertical-layout');
                document.getElementById('plans-container').classList.remove('horizontal-layout');
            }
        }

        // æ¸²æŸ“é™©ç§è¾“å…¥è¡¨å•
        function renderInsuranceInputs(planData = {}) {
            insuranceItemsContainer.innerHTML = '';
            const items = planData.items || {};
            
            for (const key in insuranceTypes) {
                const info = insuranceTypes[key];
                const itemHtml = `
                    <div class="insurance-item grid grid-cols-10 gap-2 items-center" data-key="${key}">
                        <label for="coverage-${key}" class="col-span-10 sm:col-span-3 text-sm font-medium truncate">${info.name}</label>
                        <div class="col-span-5 sm:col-span-3 relative">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ä¿é¢</span>
                            <input type="number" id="coverage-${key}" value="${items[key]?.coverage || info.defaultCoverage}" class="w-full p-2 pl-8 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        </div>
                        <div class="col-span-5 sm:col-span-3 relative">
                           <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ä¿è´¹</span>
                           <input type="number" id="premium-${key}" value="${items[key]?.premium || info.defaultPremium}" class="w-full p-2 pl-8 border rounded bg-gray-50 dark:bg-gray-700 dark:border-gray-600" required>
                        </div>
                        <i class="ti ti-grip-vertical col-span-10 sm:col-span-1 text-center text-gray-400 cursor-grab"></i>
                    </div>
                `;
                insuranceItemsContainer.insertAdjacentHTML('beforeend', itemHtml);
            }
            
            // æ‹–æ‹½æ’åºåˆå§‹åŒ–
            new Sortable(insuranceItemsContainer, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                handle: '.ti-grip-vertical',
            });
        }

        // æ¸²æŸ“æ‰€æœ‰æ–¹æ¡ˆå¡ç‰‡
        function renderPlans() {
            const sortedPlans = sortPlans(state.plans, sortBySelect.value);
            plansContainer.innerHTML = '';

            if (sortedPlans.length === 0) {
                noPlansPlaceholder.classList.remove('hidden');
                return;
            }
            
            noPlansPlaceholder.classList.add('hidden');
            
            sortedPlans.slice(0, 10).forEach(plan => {
                const totalCoverage = Object.values(plan.items).reduce((sum, item) => sum + (item.coverage || 0), 0);
                const totalPremium = Object.values(plan.items).reduce((sum, item) => sum + (item.premium || 0), 0);
                const valueRatio = totalPremium > 0 ? (totalCoverage / totalPremium).toFixed(2) : 'âˆ';

                const card = document.createElement('div');
                card.className = 'plan-card bg-white dark:bg-gray-800 p-5 rounded-xl shadow-lg flex flex-col gap-4';
                card.id = `plan-card-${plan.id}`;
                card.dataset.id = plan.id;

                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-xl font-bold text-indigo-600 dark:text-indigo-400">${plan.title}</h3>
                            <p class="text-xs text-gray-400">${new Date(plan.id).toLocaleString()}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="edit-btn p-1 hover:text-indigo-500" data-id="${plan.id}" data-tooltip="ç¼–è¾‘">
                                <i class="ti ti-pencil"></i>
                            </button>
                            <button class="delete-btn p-1 hover:text-red-500" data-id="${plan.id}" data-tooltip="åˆ é™¤">
                                <i class="ti ti-trash"></i>
                            </button>
                            <button class="export-btn p-1 hover:text-green-500" data-id="${plan.id}" data-tooltip="å¯¼å‡ºå›¾ç‰‡">
                                <i class="ti ti-photo-down"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-slate-100 dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 dark:text-gray-400">æ€»ä¿é¢</p>
                            <p class="text-lg font-bold">Â¥${totalCoverage.toLocaleString()}</p>
                        </div>
                        <div class="bg-slate-100 dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 dark:text-gray-400">æ€»ä¿è´¹</p>
                            <p class="text-lg font-bold text-red-500">Â¥${totalPremium.toLocaleString()}</p>
                        </div>
                        <div class="bg-slate-100 dark:bg-gray-700 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 dark:text-gray-400">æ€§ä»·æ¯”</p>
                            <p class="text-lg font-bold text-green-500">${valueRatio}</p>
                        </div>
                    </div>

                    <div id="chart-${plan.id}" class="chart-container"></div>

                    <details class="text-sm">
                        <summary class="cursor-pointer font-semibold text-gray-600 dark:text-gray-300">å±•å¼€æŸ¥çœ‹è¯¦æƒ…</summary>
                        <div class="mt-3 space-y-3">
                            ${ plan.company || plan.salesperson || plan.contact ? `
                            <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md">
                                <h4 class="font-bold mb-2">åŸºç¡€ä¿¡æ¯</h4>
                                <ul class="space-y-1">
                                    ${plan.company ? `<li><strong>ä¿é™©å…¬å¸:</strong> ${plan.company}</li>` : ''}
                                    ${plan.salesperson ? `<li><strong>é”€å”®:</strong> ${plan.salesperson}</li>` : ''}
                                    ${plan.contact ? `<li><strong>è”ç³»æ–¹å¼:</strong> ${plan.contact}</li>` : ''}
                                </ul>
                            </div>` : ''}

                            <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md">
                                <h4 class="font-bold mb-2">ä¿è´¹/ä¿é¢è¯¦æƒ…</h4>
                                <ul class="space-y-1">
                                    ${Object.entries(plan.items).map(([key, value]) => `
                                        <li class="flex justify-between">
                                            <span>${insuranceTypes[key].name}</span>
                                            <span>
                                                <strong>ä¿é¢:</strong> ${value.coverage.toLocaleString()} / 
                                                <strong>ä¿è´¹:</strong> <span class="text-red-500">${value.premium.toLocaleString()}</span>
                                            </span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                            
                            ${ plan.remarks ? `
                            <div class="bg-gray-50 dark:bg-gray-700/50 p-3 rounded-md">
                                <h4 class="font-bold mb-2">å¤‡æ³¨</h4>
                                <div class="prose prose-sm dark:prose-invert max-w-none">${plan.remarks}</div>
                            </div>` : ''}
                        </div>
                    </details>
                `;
                plansContainer.appendChild(card);
                renderChart(plan);
            });
        }

        // æ¸²æŸ“å¯¹æ¯”è§†å›¾
        function renderComparisonView() {
            const sortedPlans = sortPlans(state.plans, sortBySelect.value);
            comparisonContainer.innerHTML = '';
            
            if (sortedPlans.length === 0) return;
            
            const comparisonHtml = `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">æ–¹æ¡ˆå¯¹æ¯”è§†å›¾</h2>
                        <button id="exit-comparison-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">
                            é€€å‡ºå¯¹æ¯”
                        </button>
                    </div>
                    <div class="comparison-view">
                        ${sortedPlans.slice(0, 5).map(plan => {
                            const totalCoverage = Object.values(plan.items).reduce((sum, item) => sum + (item.coverage || 0), 0);
                            const totalPremium = Object.values(plan.items).reduce((sum, item) => sum + (item.premium || 0), 0);
                            const valueRatio = totalPremium > 0 ? (totalCoverage / totalPremium).toFixed(2) : 'âˆ';
                            
                            return `
                                <div class="comparison-card">
                                    <h3 class="font-bold text-lg mb-3 text-indigo-600 dark:text-indigo-400">${plan.title}</h3>
                                    <div class="mb-3">
                                        <div class="flex justify-between mb-1">
                                            <span>æ€»ä¿é¢:</span>
                                            <span class="font-bold">Â¥${totalCoverage.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between mb-1">
                                            <span>æ€»ä¿è´¹:</span>
                                            <span class="font-bold text-red-500">Â¥${totalPremium.toLocaleString()}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>æ€§ä»·æ¯”:</span>
                                            <span class="font-bold text-green-500">${valueRatio}</span>
                                        </div>
                                    </div>
                                    <div id="comparison-chart-${plan.id}" class="h-40"></div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            comparisonContainer.innerHTML = comparisonHtml;
            comparisonContainer.classList.remove('hidden');
            document.querySelector('.plans-container').classList.add('hidden');
            
            // æ¸²æŸ“å¯¹æ¯”è§†å›¾ä¸­çš„å›¾è¡¨
            sortedPlans.slice(0, 5).forEach(plan => {
                renderComparisonChart(plan);
            });
            
            // æ·»åŠ é€€å‡ºå¯¹æ¯”äº‹ä»¶
            document.getElementById('exit-comparison-btn').addEventListener('click', () => {
                comparisonContainer.classList.add('hidden');
                document.querySelector('.plans-container').classList.remove('hidden');
                state.comparisonMode = false;
            });
        }

        // æ¸²æŸ“å›¾è¡¨
        function renderChart(plan) {
            const chartDom = document.getElementById(`chart-${plan.id}`);
            if (!chartDom) return;
            
            const myChart = echarts.init(chartDom, document.documentElement.classList.contains('dark') ? 'dark' : null);
            const chartData = Object.entries(plan.items).map(([key, value]) => ({
                name: insuranceTypes[key].name,
                coverage: value.coverage,
                premium: value.premium,
            }));
            
            const option = {
                tooltip: { trigger: 'axis' },
                legend: { data: ['ä¿é¢', 'ä¿è´¹'] },
                xAxis: { 
                    type: 'category', 
                    data: chartData.map(d => d.name),
                    axisLabel: {
                        interval: 0,
                        rotate: 30
                    }
                },
                yAxis: [
                    { type: 'value', name: 'ä¿é¢' }, 
                    { type: 'value', name: 'ä¿è´¹' }
                ],
                series: [
                    { 
                        name: 'ä¿é¢', 
                        type: 'bar', 
                        data: chartData.map(d => d.coverage),
                        itemStyle: {
                            color: '#4f46e5'
                        }
                    },
                    { 
                        name: 'ä¿è´¹', 
                        type: 'line', 
                        yAxisIndex: 1, 
                        data: chartData.map(d => d.premium),
                        itemStyle: {
                            color: '#10b981'
                        }
                    }
                ],
                grid: { left: '3%', right: '4%', bottom: '15%', top: '10%', containLabel: true },
                textStyle: {
                    color: document.documentElement.classList.contains('dark') ? '#ccc' : '#333'
                }
            };
            
            myChart.setOption(option);
            
            // å“åº”çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', () => {
                myChart.resize();
            });
        }

        // æ¸²æŸ“å¯¹æ¯”è§†å›¾ä¸­çš„å›¾è¡¨
        function renderComparisonChart(plan) {
            const chartDom = document.getElementById(`comparison-chart-${plan.id}`);
            if (!chartDom) return;
            
            const myChart = echarts.init(chartDom, document.documentElement.classList.contains('dark') ? 'dark' : null);
            const chartData = Object.entries(plan.items).map(([key, value]) => ({
                name: insuranceTypes[key].name,
                coverage: value.coverage,
                premium: value.premium,
            }));
            
            const option = {
                tooltip: { trigger: 'axis' },
                xAxis: { 
                    type: 'category', 
                    data: chartData.map(d => d.name),
                    axisLabel: {
                        interval: 0,
                        rotate: 30,
                        fontSize: 10
                    }
                },
                yAxis: { type: 'value' },
                series: [
                    { 
                        name: 'ä¿è´¹', 
                        type: 'bar', 
                        data: chartData.map(d => d.premium),
                        itemStyle: {
                            color: '#10b981'
                        }
                    }
                ],
                grid: { left: '3%', right: '4%', bottom: '25%', top: '10%', containLabel: true },
                textStyle: {
                    color: document.documentElement.classList.contains('dark') ? '#ccc' : '#333'
                }
            };
            
            myChart.setOption(option);
        }

        // æ’åºæ–¹æ¡ˆ
        function sortPlans(plans, sortBy) {
            return [...plans].sort((a, b) => {
                const totalPremiumA = Object.values(a.items).reduce((s, i) => s + i.premium, 0);
                const totalPremiumB = Object.values(b.items).reduce((s, i) => s + i.premium, 0);
                const totalCoverageA = Object.values(a.items).reduce((s, i) => s + i.coverage, 0);
                const totalCoverageB = Object.values(b.items).reduce((s, i) => s + i.coverage, 0);

                switch (sortBy) {
                    case 'date_asc': return a.id - b.id;
                    case 'premium_asc': return totalPremiumA - totalPremiumB;
                    case 'premium_desc': return totalPremiumB - totalPremiumA;
                    case 'coverage_desc': return totalCoverageB - totalCoverageA;
                    default: return b.id - a.id; // date_desc
                }
            });
        }
        
        // ä¿å­˜æ•°æ®
        function persistData() {
            localStorage.setItem('insurancePlans', JSON.stringify(state.plans));
        }
        
        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            form.reset();
            planIdInput.value = '';
            quill.root.innerHTML = '';
            state.editingId = null;
            renderInsuranceInputs();
            document.querySelector('h2 span').textContent = 'æ·»åŠ /ç¼–è¾‘æ–¹æ¡ˆ';
        }

        // å¯¼å‡ºå›¾ç‰‡
        async function exportImage(element, filename) {
            const canvas = await html2canvas(element, { 
                useCORS: true,
                scale: 2,
                backgroundColor: document.documentElement.classList.contains('dark') ? '#111827' : '#f1f5f9'
            });
            
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // æ˜¾ç¤ºå¯¼å‡ºæ¨¡æ€æ¡†
        function showExportModal() {
            // å…‹éš†å¯¹æ¯”è§†å›¾
            const comparisonView = document.querySelector('.comparison-view');
            if (comparisonView) {
                const clone = comparisonView.cloneNode(true);
                clone.classList.remove('comparison-view');
                clone.classList.add('export-comparison');
                exportPreview.innerHTML = '';
                exportPreview.appendChild(clone);
            }
            
            exportModal.classList.remove('hidden');
        }

        // äº‹ä»¶ç›‘å¬å™¨
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = state.editingId || Date.now();
            const orderedItems = {};
            
            document.querySelectorAll('#insurance-items-container .insurance-item').forEach(itemEl => {
                const key = itemEl.dataset.key;
                orderedItems[key] = {
                    coverage: parseFloat(document.getElementById(`coverage-${key}`).value) || 0,
                    premium: parseFloat(document.getElementById(`premium-${key}`).value) || 0,
                };
            });

            const plan = {
                id,
                title: planTitleInput.value,
                company: document.getElementById('insurance-company').value,
                salesperson: document.getElementById('salesperson').value,
                contact: document.getElementById('contact-info').value,
                items: orderedItems,
                remarks: quill.root.innerHTML,
            };

            if (state.editingId) {
                const index = state.plans.findIndex(p => p.id === state.editingId);
                state.plans[index] = plan;
            } else {
                state.plans.push(plan);
            }
            
            persistData();
            renderPlans();
            clearForm();
            alert('æ–¹æ¡ˆå·²ä¿å­˜ï¼');
        });

        quill.root.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
            }
        });

        clearFormBtn.addEventListener('click', () => {
            clearForm();
            alert('è¡¨å•å·²æ¸…ç©ºã€‚');
        });

        sortBySelect.addEventListener('change', renderPlans);
        
        // å¸ƒå±€åˆ‡æ¢äº‹ä»¶
        horizontalLayoutBtn.addEventListener('click', () => {
            state.layout = 'horizontal';
            localStorage.setItem('layout', 'horizontal');
            initLayout();
            renderPlans();
        });
        
        verticalLayoutBtn.addEventListener('click', () => {
            state.layout = 'vertical';
            localStorage.setItem('layout', 'vertical');
            initLayout();
            renderPlans();
        });
        
        // å¯¹æ¯”è§†å›¾äº‹ä»¶
        comparisonViewBtn.addEventListener('click', () => {
            if (state.plans.length === 0) {
                alert('è¯·å…ˆæ·»åŠ æ–¹æ¡ˆè¿›è¡Œå¯¹æ¯”');
                return;
            }
            
            state.comparisonMode = true;
            renderComparisonView();
        });
        
        // å¯¼å‡ºäº‹ä»¶
        exportAllBtn.addEventListener('click', () => {
            if (state.plans.length === 0) {
                alert('è¯·å…ˆæ·»åŠ æ–¹æ¡ˆ');
                return;
            }
            
            showExportModal();
        });
        
        // å…³é—­å¯¼å‡ºæ¨¡æ€æ¡†
        closeExportModal.addEventListener('click', () => {
            exportModal.classList.add('hidden');
        });
        
        // å¯¼å‡ºPNG
        exportPngBtn.addEventListener('click', async () => {
            const element = exportPreview;
            const canvas = await html2canvas(element, { 
                useCORS: true,
                scale: 2,
                backgroundColor: document.documentElement.classList.contains('dark') ? '#111827' : '#f1f5f9'
            });
            
            const link = document.createElement('a');
            link.download = 'è½¦é™©æ–¹æ¡ˆå¯¹æ¯”å›¾.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
        
        // å¯¼å‡ºPDF
        exportPdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            const element = exportPreview;
            const canvas = await html2canvas(element, { 
                useCORS: true,
                scale: 2,
                backgroundColor: document.documentElement.classList.contains('dark') ? '#111827' : '#f1f5f9'
            });
            
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('l', 'mm', 'a4');
            const imgWidth = pdf.internal.pageSize.getWidth();
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
            pdf.save('è½¦é™©æ–¹æ¡ˆå¯¹æ¯”å›¾.pdf');
        });

        // ä¸»é¢˜åˆ‡æ¢
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
            renderPlans();
        });
        
        // è¯­è¨€åˆ‡æ¢
        langSwitcher.addEventListener('change', (e) => {
            state.currentLanguage = e.target.value;
            localStorage.setItem('language', e.target.value);
            renderPlans();
        });

        // äº‹ä»¶å§”æ‰˜ï¼šå¤„ç†å¡ç‰‡ä¸Šçš„æŒ‰é’®ç‚¹å‡»
        document.querySelector('.plans-container').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = Number(target.dataset.id);

            // ç¼–è¾‘
            if (target.classList.contains('edit-btn')) {
                const plan = state.plans.find(p => p.id === id);
                state.editingId = id;
                planIdInput.value = id;
                planTitleInput.value = plan.title;
                document.getElementById('insurance-company').value = plan.company;
                document.getElementById('salesperson').value = plan.salesperson;
                document.getElementById('contact-info').value = plan.contact;
                quill.root.innerHTML = plan.remarks;
                renderInsuranceInputs(plan);
                document.querySelector('h2 span').textContent = 'ç¼–è¾‘æ–¹æ¡ˆ';
                window.scrollTo(0, 0);
            }
            // åˆ é™¤
            else if (target.classList.contains('delete-btn')) {
                if (confirm('æ‚¨ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–¹æ¡ˆå—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                    state.plans = state.plans.filter(p => p.id !== id);
                    persistData();
                    renderPlans();
                }
            }
            // å¯¼å‡ºå•ä¸ªå›¾ç‰‡
            else if (target.classList.contains('export-btn')) {
                const cardElement = document.getElementById(`plan-card-${id}`);
                const planTitle = state.plans.find(p => p.id === id).title;
                exportImage(cardElement, `${planTitle}.png`);
            }
        });

        // åˆå§‹åŒ–
        function init() {
            // è®¾ç½®åˆå§‹ä¸»é¢˜
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            
            // è®¾ç½®åˆå§‹è¯­è¨€
            langSwitcher.value = state.currentLanguage;
            
            // åˆå§‹åŒ–å¸ƒå±€
            initLayout();
            
            // é¦–æ¬¡æ¸²æŸ“
            renderInsuranceInputs();
            renderPlans();
        }

        init();
    });
    </script>
</body>
</html>