<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script defer src="https://cloud.umami.is/script.js" data-website-id="310332c6-bb2a-4410-90c1-0d681395f9b2"></script>
    <title>商品房信息管理系统</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #1a2530);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #bdc3c7;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .list-section {
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 20px;
            color: #2c3e50;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
        }

        .form-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .form-group label {
            width: 100px;
            font-weight: 600;
            color: #2c3e50;
            padding-top: 5px;
            min-width: 100px;
        }

        .input-field {
            flex: 1;
            min-width: 200px;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }

        .floor-inputs {
            display: flex;
            gap: 10px;
        }

        .floor-inputs input {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-save {
            background: #3498db;
            color: white;
        }

        .btn-save:hover {
            background: #2980b9;
        }

        .btn-reset {
            background: #f39c12;
            color: white;
        }

        .btn-reset:hover {
            background: #d35400;
        }

        .btn-export {
            background: #2ecc71;
            color: white;
        }

        .btn-export:hover {
            background: #27ae60;
        }

        .btn-import {
            background: #e74c3c;
            color: white;
        }

        .btn-import:hover {
            background: #c0392b;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th, .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .data-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .data-table tr:hover {
            background-color: #f5f7fa;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 5px 10px;
            font-size: 12px;
        }

        .edit-btn {
            background: #3498db;
            color: white;
        }

        .edit-btn:hover {
            background: #2980b9;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
        }

        .delete-btn:hover {
            background: #c0392b;
        }

        .filter-section {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-section select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            min-width: 180px;
        }

        .filter-btn {
            padding: 10px 20px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn:hover {
            background: #c0392b;
        }

        .clear-filter {
            background: #f39c12;
            color: white;
        }

        .clear-filter:hover {
            background: #d35400;
        }

        .unit-display {
            font-weight: bold;
            color: #e74c3c;
            margin-top: 5px;
            font-size: 16px;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #eee;
        }

        /* 备注字段样式 */
        .notes-field {
            height: 80px;
            resize: vertical;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>商品房信息管理系统</h1>
            <p>高效管理您的房产信息，支持导入导出与数据筛选</p>
        </div>

        <div class="content">
            <!-- 表单区域 -->
            <div class="form-section">
                <h2 class="section-title">添加/编辑商品房信息</h2>

                <div class="form-group">
                    <label for="community">小区名称</label>
                    <input type="text" id="community" class="input-field" required>

                    <label for="city">所在城市</label>
                    <input type="text" id="city" class="input-field" required>

                    <label for="district">区域位置</label>
                    <input type="text" id="district" class="input-field" required>
                </div>

                <div class="form-group">
                    <label for="totalPrice">总价(万元)</label>
                    <input type="number" id="totalPrice" class="input-field" step="0.01" min="0" required>

                    <label for="area">建筑面积(m²)</label>
                    <input type="number" id="area" class="input-field" step="0.01" min="0" required>

                    <label for="unitPrice">单价(元/m²)</label>
                    <div class="input-field unit-display" id="unitPrice">0.00</div>
                </div>

                <div class="form-group">
                    <label for="layout">户型</label>
                    <input type="text" id="layout" class="input-field" placeholder="如：3室2厅" required>

                    <label for="orientation">朝向</label>
                    <select id="orientation" class="input-field">
                        <option value="">请选择</option>
                        <option value="东">东</option>
                        <option value="南">南</option>
                        <option value="西">西</option>
                        <option value="北">北</option>
                        <option value="东南">东南</option>
                        <option value="西南">西南</option>
                        <option value="东北">东北</option>
                        <option value="西北">西北</option>
                    </select>

                    <label for="decoration">装修程度</label>
                    <select id="decoration" class="input-field">
                        <option value="">请选择</option>
                        <option value="毛坯">毛坯</option>
                        <option value="简装">简装</option>
                        <option value="精装">精装</option>
                        <option value="豪装">豪装</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="currentFloor">楼层</label>
                    <div class="floor-inputs">
                        <input type="number" id="currentFloor" class="input-field" placeholder="所在楼层" min="1">
                        <span style="align-self: center; padding: 10px;">/</span>
                        <input type="number" id="totalFloors" class="input-field" placeholder="总楼层" min="1">
                    </div>

                    <label for="buildYear">建成年代</label>
                    <input type="number" id="buildYear" class="input-field" min="1900" max="2030">

                    <label for="propertyTerm">产权年限(年)</label>
                    <input type="number" id="propertyTerm" class="input-field" min="1" max="100">
                </div>

                <div class="form-group">
                    <label for="usage">房屋用途</label>
                    <select id="usage" class="input-field">
                        <option value="">请选择</option>
                        <option value="住宅">住宅</option>
                        <option value="商业">商业</option>
                        <option value="办公">办公</option>
                        <option value="工业">工业</option>
                        <option value="其他">其他</option>
                    </select>

                    <label for="hasElevator">是否有电梯</label>
                    <select id="hasElevator" class="input-field">
                        <option value="">请选择</option>
                        <option value="是">是</option>
                        <option value="否">否</option>
                    </select>
                </div>

                <!-- 新增备注字段 -->
                <div class="form-group">
                    <label for="notes">备注</label>
                    <textarea id="notes" class="input-field notes-field" placeholder="请输入相关备注信息..."></textarea>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn-save" id="saveBtn">保存信息</button>
                    <button type="button" class="btn-reset" id="resetBtn">重置表单</button>
                    <button type="button" class="btn-export" id="exportBtn">导出Excel</button>
                    <button type="button" class="btn-import" id="importBtn">导入Excel</button>
                </div>
            </div>

            <!-- 列表区域 -->
            <div class="list-section">
                <h2 class="section-title">商品房信息列表</h2>

                <div class="filter-section">
                    <div>
                        <label for="filterCity">按城市筛选</label>
                        <select id="filterCity">
                            <option value="">全部城市</option>
                        </select>
                    </div>

                    <div>
                        <label for="filterDistrict">按区域筛选</label>
                        <select id="filterDistrict">
                            <option value="">全部区域</option>
                        </select>
                    </div>

                    <button class="filter-btn clear-filter" id="clearFilter">清除筛选</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr>
                            <th>小区名称</th>
                            <th>所在城市</th>
                            <th>区域位置</th>
                            <th>总价(万)</th>
                            <th>面积(m²)</th>
                            <th>单价(元/m²)</th>
                            <th>户型</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="propertyList">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>商品房信息管理系统 &copy; 2026 | 纯静态前端实现</p>
        </footer>
    </div>

    <script>
        // 全局变量存储商品房数据
        let properties = JSON.parse(localStorage.getItem('properties')) || [];
        let editingIndex = -1; // 当前正在编辑的记录索引

        // 页面加载完成后初始化
        $(document).ready(function() {
            renderPropertyList();
            setupEventListeners();
            populateFilterDropdowns();
            calculateUnitPrice(); // 初始化时计算单价
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 表单提交事件
            $('#saveBtn').on('click', saveProperty);

            // 重置表单
            $('#resetBtn').on('click', resetForm);

            // 单价计算
            $('#totalPrice, #area').on('input', calculateUnitPrice);

            // 导出功能
            $('#exportBtn').on('click', exportToExcel);

            // 导入功能
            $('#importBtn').on('click', importFromExcel);

            // 筛选功能
            $('#filterCity, #filterDistrict').on('change', applyFilter);
            $('#clearFilter').on('click', clearFilter);
        }

        // 计算并显示单价
        function calculateUnitPrice() {
            const totalPrice = parseFloat($('#totalPrice').val()) || 0;
            const area = parseFloat($('#area').val()) || 0;

            if (area > 0) {
                const unitPrice = (totalPrice * 10000 / area).toFixed(2);
                $('#unitPrice').text(unitPrice);
            } else {
                $('#unitPrice').text('0.00');
            }
        }

        // 保存商品房信息
        function saveProperty() {
            const property = {
                community: $('#community').val().trim(),
                city: $('#city').val().trim(),
                district: $('#district').val().trim(),
                totalPrice: parseFloat($('#totalPrice').val()) || 0,
                area: parseFloat($('#area').val()) || 0,
                layout: $('#layout').val().trim(),
                orientation: $('#orientation').val(),
                decoration: $('#decoration').val(),
                currentFloor: parseInt($('#currentFloor').val()) || null,
                totalFloors: parseInt($('#totalFloors').val()) || null,
                buildYear: parseInt($('#buildYear').val()) || null,
                propertyTerm: parseInt($('#propertyTerm').val()) || null,
                usage: $('#usage').val(),
                hasElevator: $('#hasElevator').val(),
                notes: $('#notes').val().trim(), // 新增备注字段
                addTime: new Date().toLocaleString('zh-CN')
            };

            // 验证必填字段
            if (!property.community || !property.city || !property.district ||
                property.totalPrice <= 0 || property.area <= 0 || !property.layout) {
                alert('请填写所有带*的必填字段，并确保总价和面积大于0');
                return;
            }

            // 计算单价
            property.unitPrice = (property.totalPrice * 10000 / property.area).toFixed(2);

            if (editingIndex === -1) {
                // 新增记录
                properties.push(property);
            } else {
                // 更新记录
                properties[editingIndex] = property;
                editingIndex = -1;
            }

            // 保存到localStorage
            localStorage.setItem('properties', JSON.stringify(properties));

            // 重新渲染列表
            renderPropertyList();

            // 重置表单
            resetForm();

            alert(editingIndex === -1 ? '商品房信息已成功添加！' : '商品房信息已成功更新！');
        }

        // 重置表单
        function resetForm() {
            $('#community').val('');
            $('#city').val('');
            $('#district').val('');
            $('#totalPrice').val('');
            $('#area').val('');
            $('#layout').val('');
            $('#orientation').val('');
            $('#decoration').val('');
            $('#currentFloor').val('');
            $('#totalFloors').val('');
            $('#buildYear').val('');
            $('#propertyTerm').val('');
            $('#usage').val('');
            $('#hasElevator').val('');
            $('#notes').val(''); // 重置备注字段
            $('#unitPrice').text('0.00');
            editingIndex = -1;
            $('#saveBtn').text('保存信息');
        }

        // 渲染商品房列表
        function renderPropertyList(filteredProperties = null) {
            const list = filteredProperties || properties;
            const tbody = $('#propertyList');
            tbody.empty();

            if (list.length === 0) {
                tbody.append('<tr><td colspan="9" style="text-align:center;">暂无商品房信息</td></tr>');
                return;
            }

            list.forEach((property, index) => {
                // 截断过长的备注内容
                const truncatedNotes = property.notes && property.notes.length > 30
                    ? property.notes.substring(0, 30) + '...'
                    : property.notes || '';

                const row = `
                    <tr>
                        <td>${property.community}</td>
                        <td>${property.city}</td>
                        <td>${property.district}</td>
                        <td>${property.totalPrice.toFixed(2)}</td>
                        <td>${property.area.toFixed(2)}</td>
                        <td>${property.unitPrice}</td>
                        <td>${property.layout}</td>
                        <td title="${property.notes || ''}">${truncatedNotes}</td>
                        <td class="action-buttons">
                            <button class="edit-btn" data-index="${index}">编辑</button>
                            <button class="delete-btn" data-index="${index}">删除</button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // 为编辑和删除按钮添加事件
            $('.edit-btn').off('click').on('click', function() {
                const index = $(this).data('index');
                editProperty(index);
            });

            $('.delete-btn').off('click').on('click', function() {
                const index = $(this).data('index');
                deleteProperty(index);
            });
        }

        // 编辑商品房信息
        function editProperty(index) {
            const property = properties[index];
            editingIndex = index;

            // 填充表单
            $('#community').val(property.community);
            $('#city').val(property.city);
            $('#district').val(property.district);
            $('#totalPrice').val(property.totalPrice);
            $('#area').val(property.area);
            $('#layout').val(property.layout);
            $('#orientation').val(property.orientation);
            $('#decoration').val(property.decoration);
            $('#currentFloor').val(property.currentFloor || '');
            $('#totalFloors').val(property.totalFloors || '');
            $('#buildYear').val(property.buildYear || '');
            $('#propertyTerm').val(property.propertyTerm || '');
            $('#usage').val(property.usage);
            $('#hasElevator').val(property.hasElevator);
            $('#notes').val(property.notes || ''); // 填充备注字段

            // 计算并显示单价
            calculateUnitPrice();

            // 滚动到表单顶部
            $('.form-section')[0].scrollIntoView({ behavior: 'smooth' });
            $('#saveBtn').text('更新信息');
        }

        // 删除商品房信息
        function deleteProperty(index) {
            if (confirm('确定要删除这条商品房信息吗？')) {
                properties.splice(index, 1);
                localStorage.setItem('properties', JSON.stringify(properties));
                renderPropertyList();
                alert('商品房信息已成功删除！');
            }
        }

        // 填充筛选下拉框
        function populateFilterDropdowns() {
            const cities = [...new Set(properties.map(p => p.city))];
            const districts = [...new Set(properties.map(p => p.district))];

            // 填充城市下拉框
            $('#filterCity').empty();
            $('#filterCity').append('<option value="">全部城市</option>');
            cities.forEach(city => {
                $('#filterCity').append(`<option value="${city}">${city}</option>`);
            });

            // 填充区域下拉框
            $('#filterDistrict').empty();
            $('#filterDistrict').append('<option value="">全部区域</option>');
            districts.forEach(district => {
                $('#filterDistrict').append(`<option value="${district}">${district}</option>`);
            });
        }

        // 应用筛选
        function applyFilter() {
            const city = $('#filterCity').val();
            const district = $('#filterDistrict').val();

            const filtered = properties.filter(property => {
                const matchCity = !city || property.city === city;
                const matchDistrict = !district || property.district === district;
                return matchCity && matchDistrict;
            });

            renderPropertyList(filtered);
        }

        // 清除筛选
        function clearFilter() {
            $('#filterCity').val('');
            $('#filterDistrict').val('');
            renderPropertyList();
        }

        // 导出到Excel
        function exportToExcel() {
            if (properties.length === 0) {
                alert('没有数据可导出！');
                return;
            }

            // 准备数据
            const data = properties.map(property => ({
                '小区名称': property.community,
                '所在城市': property.city,
                '区域位置': property.district,
                '总价(万元)': property.totalPrice,
                '建筑面积(m²)': property.area,
                '单价(元/m²)': property.unitPrice,
                '户型': property.layout,
                '朝向': property.orientation || '',
                '装修程度': property.decoration || '',
                '所在楼层': property.currentFloor || '',
                '总楼层': property.totalFloors || '',
                '建成年代': property.buildYear || '',
                '产权年限': property.propertyTerm || '',
                '房屋用途': property.usage || '',
                '是否有电梯': property.hasElevator || '',
                '备注': property.notes || '', // 包含备注字段
                '添加时间': property.addTime
            }));

            // 创建工作簿
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "商品房信息");

            // 导出文件
            XLSX.writeFile(wb, "商品房信息.xlsx");
        }

        // 从Excel导入
        function importFromExcel() {
            // 创建一个隐藏的文件输入元素
            const fileInput = $('<input type="file" accept=".xlsx, .xls" style="display:none;">');
            $('body').append(fileInput);

            fileInput.on('change', function(e) {
                const file = e.target.files[0];
                if (!file) {
                    fileInput.remove();
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        // 处理导入的数据
                        const importedProperties = jsonData.map(row => {
                            // 转换数据类型
                            const property = {
                                community: row['小区名称'] || '',
                                city: row['所在城市'] || '',
                                district: row['区域位置'] || '',
                                totalPrice: parseFloat(row['总价(万元)']) || 0,
                                area: parseFloat(row['建筑面积(m²)']) || 0,
                                layout: row['户型'] || '',
                                orientation: row['朝向'] || '',
                                decoration: row['装修程度'] || '',
                                currentFloor: parseInt(row['所在楼层']) || null,
                                totalFloors: parseInt(row['总楼层']) || null,
                                buildYear: parseInt(row['建成年代']) || null,
                                propertyTerm: parseInt(row['产权年限']) || null,
                                usage: row['房屋用途'] || '',
                                hasElevator: row['是否有电梯'] || '',
                                notes: row['备注'] || '', // 导入备注字段
                                addTime: row['添加时间'] || new Date().toLocaleString('zh-CN')
                            };

                            // 计算单价
                            property.unitPrice = (property.totalPrice * 10000 / property.area).toFixed(2);

                            return property;
                        });

                        // 添加到现有数据中（去重处理）
                        const existingCommunities = new Set(properties.map(p => p.community + p.city + p.district));
                        const newProperties = importedProperties.filter(p =>
                            !existingCommunities.has(p.community + p.city + p.district)
                        );

                        if (newProperties.length > 0) {
                            properties = properties.concat(newProperties);
                            localStorage.setItem('properties', JSON.stringify(properties));
                            renderPropertyList();
                            populateFilterDropdowns(); // 更新筛选下拉框
                            alert(`成功导入 ${newProperties.length} 条新记录！`);
                        } else {
                            alert('没有发现新记录，所有数据已存在！');
                        }
                    } catch (error) {
                        console.error('导入错误:', error);
                        alert('导入失败，请检查Excel文件格式是否正确！');
                    }

                    fileInput.remove();
                };
                reader.readAsArrayBuffer(file);
            });

            fileInput.click();
        }
    </script>
</body>
</html>